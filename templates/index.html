<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Home Tracker</title>
    <link rel="stylesheet" href="static/styles/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@0.7.7/dist/chartjs-plugin-zoom.min.js"></script>
  </head>
  <body>
    <header>
      <h1 class="title">üè° Home Tracker</h1>
      <div class="zip-input-container">
        <label for="zipCode">Enter Zip Code: </label>
        <input
          type="text"
          id="zipCode"
          name="zipCode"
          placeholder="Type in a valid zip code"
        />
        <button id="enterButton">Enter</button>
      </div>
    </header>
    <div class="container">
      <div class="graph-section">
        <h2>üìà Real Estate Market Overview</h2>
        <canvas id="chart_bedPrice" width="800" height="400"></canvas>
        <div class="graph-controls">
          <button id="resetZoom">üîÑ Reset Zoom</button>
        </div>
      </div>
      <div class="info-section">
        <h2>üèòÔ∏è Property Details</h2>
        <div class="grid-container">
          <div id="propertyPicture" class="info-box">
            <p>Select a property from the graph to see details here.</p>
          </div>
          <div id="propertyInfo" class="info-box">
            <p>Select a property from the graph to see details here.</p>
          </div>
        </div>
      </div>
    </div>
    <script>
      document
        .getElementById("enterButton")
        .addEventListener("click", async function () {
          const enterButton = document.getElementById("enterButton");
          const zipCode = document.getElementById("zipCode").value;

          try {
            const response = await fetch("/get_listings", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ zipCode: zipCode }),
            });
            const data = await response.json();

            if (data.message) {
              alert(data.message);
              await chartIt_bedPrice(zipCode); // Wait for chart to load
            } else if (data.error) {
              alert(data.error);
            }
          } catch (error) {
            alert("There was an error with the request.");
          }
        });

      document.addEventListener("click", function () {
        document.getElementById("zipCode").value = "";
        document.getElementById("propertyPicture").innerHTML =
          "<p>Select a property from the graph to see details here.</p>";
        document.getElementById("propertyInfo").innerHTML =
          "<p>Select a property from the graph to see details here.</p>";
        const chartCanvas = document.getElementById("chart_bedPrice");
        const ctx = chartCanvas.getContext("2d");
        ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
      });

      const beds = [];
      const baths = [];
      const price = [];
      const hasImage = [];
      const imgSrc = [];
      const detailUrl = [];
      const address = [];
      const area = [];

      async function getData(zipCode) {
        const response = await fetch(`/static/${zipCode}.csv`);
        // console.log(zipCode)
        const text = await response.text();
        Papa.parse(text, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => {
            results.data.forEach((row) => {
              beds.push(parseFloat(row.beds) || 0);
              baths.push(parseFloat(row.baths) || 0);
              price.push(parseFloat(row.unformattedPrice) || 0);
              hasImage.push(row.hasImage || "");
              imgSrc.push(row.imgSrc || "");
              detailUrl.push(row.detailUrl || "");
              address.push(row.address || "");
              area.push(parseFloat(row.area) || 0);
            });
          },
        });
      }
      async function deleteFile(zipCode) {
        const fs = require("fs");
        filePath = `/static/${zipCode}.csv`;
        fs.unlink(filePath, (err) => {
          if (err) {
            console.error(`Error deleting file: ${err}`);
            return;
          }
          console.log(`File ${filePath} deleted successfully.`);
        });
      }
      async function chartIt_bedPrice(zipCode) {
        await getData(zipCode);
        const ctx = document.getElementById("chart_bedPrice");
        const myChart = new Chart(ctx, {
          type: "scatter",
          data: {
            labels: beds,
            datasets: [
              {
                label: "House Price to Beds",
                data: price.map((y, index) => ({ x: beds[index], y })),
                borderColor: "#4CAF50",
                backgroundColor: "#81C784",
                borderWidth: 2,
                pointRadius: 6,
                hoverRadius: 8,
                fill: false,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              yAxes: [{ ticks: { beginAtZero: true } }],
              xAxes: [{ ticks: { beginAtZero: true } }],
            },
            plugins: {
              zoom: {
                zoom: {
                  enabled: true,
                  mode: "xy",
                  speed: 0.05,
                },
              },
            },
            onClick: (e) => {
              const points = myChart.getElementsAtEvent(e);
              if (points.length > 0) {
                const pointIndex = points[0]._index;
                document.getElementById("propertyInfo").innerHTML = `
                    <h3>Property Info</h3>
                      <p><strong>Detail URL:</strong> <a href="${
                        detailUrl[pointIndex]
                      }" target="_blank">View Listing</a></p>
                      <p><strong>Beds:</strong> ${beds[pointIndex]}</p>
                      <p><strong>Baths:</strong> ${baths[pointIndex]}</p>
                      <p><strong>Area:</strong> ${area[pointIndex]} sq ft</p>
                      <p><strong>Price:</strong> $${price[
                        pointIndex
                      ].toLocaleString()}</p>
                      <p><strong>Address:</strong> ${address[pointIndex]}</p>
                    `;

                if (imgSrc[pointIndex] == "False") {
                  document.getElementById("propertyPicture").innerHTML = `
                        <p><strong>Sorry. Images aren't available</strong></p>
                      `;
                } else {
                  document.getElementById("propertyPicture").innerHTML = `
                        <h3>Property Image</h3>
                        <img src="${imgSrc[pointIndex]}" alt="Property Image"
                          style="width: 80%; height: auto; max-width: 400px; border-radius: 10px;
                          box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: block; margin: 0 auto;">
                      `;
                }
              }
            },
          },
        });
        // deleteFile(zipCode);
        document
          .getElementById("resetZoom")
          .addEventListener("click", () => myChart.resetZoom());
      }
    </script>
  </body>
</html>
